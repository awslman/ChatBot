package LLM.ResponseGenerator;import Data.DatabaseManager;import com.alibaba.dashscope.aigc.generation.Generation;import com.alibaba.dashscope.aigc.generation.GenerationParam;import com.alibaba.dashscope.aigc.generation.GenerationResult;import com.alibaba.dashscope.common.Message;import com.alibaba.dashscope.common.Role;import com.alibaba.dashscope.exception.InputRequiredException;import com.alibaba.dashscope.exception.NoApiKeyException;import java.util.ArrayList;import java.io.InputStream;import java.io.InputStreamReader;import java.nio.charset.StandardCharsets;import com.google.gson.JsonObject;import com.google.gson.JsonParser;import LLM.ModelHandler;import io.reactivex.Flowable;/** * 通用模型处理器 * 该类实现了ModelHandler接口，用于处理与DashScope平台上的大语言模型交互， * 支持生成模型响应和流式响应功能。 */public class GenericModelHandler implements ModelHandler {    private final String modelName;    private final ArrayList<Message> messages;    private final DatabaseManager historyManager;    /**     * 构造函数，使用默认系统消息     *     * @param modelName 模型名称     */    public GenericModelHandler(String modelName) {        this(modelName, "You are a helpful assistant.");    }    /**     * 构造函数     *     * @param modelName     模型名称     * @param systemMessage 系统消息内容     */    public GenericModelHandler(String modelName, String systemMessage) {        this.modelName = modelName;        String sessionId = java.util.UUID.randomUUID().toString();                // 初始化对话历史管理器        this.historyManager = new DatabaseManager(sessionId);                // 构建系统消息        Message systemMsg = Message.builder()                .role(Role.SYSTEM.getValue())                .content(systemMessage)                .build();        this.messages = new ArrayList<>();        this.messages.add(systemMsg);                // 从数据库加载历史记录        ArrayList<Message> history = historyManager.loadHistory();        this.messages.addAll(history);    }    /**     * 生成模型响应     *     * @param userInput 用户输入     * @return 模型生成的文本内容     * @throws Exception 模型调用异常     */    @Override    public String generateResponse(String userInput) throws Exception {        // 输入验证        if (userInput == null || userInput.isEmpty()) {            throw new InputRequiredException("Input is required but got null or empty.");        }        // API密钥验证        String apiKey = loadApiKeyFromConfig();        if (apiKey == null || apiKey.isEmpty()) {            throw new NoApiKeyException();        }        Generation gen = new Generation();        // 构建用户消息        Message userMsg = Message.builder()                .role(Role.USER.getValue())                .content(userInput)                .build();        // 添加用户消息到历史记录        this.messages.add(userMsg);        historyManager.saveMessage(userMsg, messages.size() - 1);        // 构建生成参数        GenerationParam param = GenerationParam.builder()                .apiKey(apiKey)                .model(modelName)                .messages(messages)                .resultFormat(GenerationParam.ResultFormat.MESSAGE)                .build();        GenerationResult result = gen.call(param);        // 结果验证        if (result.getOutput() == null || result.getOutput().getChoices() == null ||                result.getOutput().getChoices().isEmpty()) {            throw new InputRequiredException("Invalid result.");        }        String responseContent = result.getOutput().getChoices().get(0).getMessage().getContent();        Message botMsg = Message.builder()                .role(Role.ASSISTANT.getValue())                .content(responseContent)                .build();        this.messages.add(botMsg);        historyManager.saveMessage(botMsg, messages.size() - 1);        return responseContent;    }    /**     * 生成模型响应：流式     *     * @param userInput 用户输入     * @return 模型生成的文本内容流     * @throws Exception 模型调用异常     */    @Override    public Flowable<String> generateResponseStream(String userInput) throws Exception {        // 输入验证        if (userInput == null || userInput.isEmpty()) {            throw new InputRequiredException("Input is required but got null or empty.");        }        // API密钥验证        String apiKey = loadApiKeyFromConfig();        if (apiKey == null || apiKey.isEmpty()) {            throw new NoApiKeyException();        }        Generation gen = new Generation();        // 构建用户消息        Message userMsg = Message.builder()                .role(Role.USER.getValue())                .content(userInput)                .build();        this.messages.add(userMsg);        historyManager.saveMessage(userMsg, messages.size() - 1);        // 构建流式生成参数        GenerationParam param = GenerationParam.builder()                .apiKey(apiKey)                .model(modelName)                .messages(messages)                .resultFormat(GenerationParam.ResultFormat.MESSAGE)                .incrementalOutput(true)                .build();        // 处理流式结果并过滤有效内容        return gen.streamCall(param)                .filter(result -> result != null && result.getOutput() != null &&                        result.getOutput().getChoices() != null &&                        !result.getOutput().getChoices().isEmpty())                .map(result -> {                    String content = result.getOutput().getChoices().get(0).getMessage().getContent();                    return content != null ? content : "";                });    }    /**     * 添加Bot消息     *     * @param content 消息内容     */    @Override    public void addBotMessage(String content) {        Message botMsg = Message.builder()                .role(Role.ASSISTANT.getValue())                .content(content)                .build();        this.messages.add(botMsg);        historyManager.saveMessage(botMsg, messages.size() - 1);    }        /**      * 从配置文件中加载API密钥     *      * @return API密钥字符串     * @throws NoApiKeyException 当配置文件中找不到API密钥时抛出异常     */    private String loadApiKeyFromConfig() throws NoApiKeyException {        try (InputStream input = getClass().getClassLoader().getResourceAsStream("app_config.json")) {            if (input == null) {                throw new NoApiKeyException();            }                        try (InputStreamReader reader = new InputStreamReader(input, StandardCharsets.UTF_8)) {                JsonObject config = JsonParser.parseReader(reader).getAsJsonObject();                                if (config.has("DASHSCOPE_API_KEY")) {                    return config.get("DASHSCOPE_API_KEY").getAsString();                } else {                    throw new NoApiKeyException();                }            }        } catch (Exception e) {            throw new NoApiKeyException();        }    }}