package Data;import com.alibaba.dashscope.common.Message;import java.io.IOException;import java.io.InputStream;import java.io.InputStreamReader;import java.nio.charset.StandardCharsets;import java.sql.Connection;import java.sql.DriverManager;import java.sql.PreparedStatement;import java.sql.ResultSet;import java.sql.SQLException;import java.sql.Statement;import java.util.ArrayList;import java.util.logging.Logger;import java.util.logging.Level;import com.google.gson.JsonObject;import com.google.gson.JsonParser;import com.google.gson.JsonSyntaxException;/** * 对话历史管理器 * 负责对话历史的数据库存储和检索 */public class DatabaseManager {    private static final Logger logger = Logger.getLogger(DatabaseManager.class.getName());    private final String tableName;        // 数据库连接信息（从配置文件中读取）    private static final String DB_URL;    private static final String DB_USER;    private static final String DB_PASSWORD;        // 控制是否允许打印日志    private static final boolean PERMIT_PRINT;        // 静态初始化块，用于加载配置文件    static {        String dbUrl = "jdbc:mysql://localhost:3306/chatbot_data";        String dbUser = "ChatBot";        String dbPassword = "123456";        boolean permitPrint = false;                // 尝试加载MySQL驱动        try {            Class.forName("com.mysql.cj.jdbc.Driver");        } catch (ClassNotFoundException e) {            if (permitPrint) logger.log(Level.WARNING, "MySQL JDBC驱动未找到", e);        }                try (InputStream input = DatabaseManager.class.getClassLoader().getResourceAsStream("app_config.json")) {            if (input == null) {                if (permitPrint) logger.log(Level.WARNING, "无法找到 app_config.json 配置文件，使用默认配置");            } else {                try (InputStreamReader reader = new InputStreamReader(input, StandardCharsets.UTF_8)) {                    JsonObject config = JsonParser.parseReader(reader).getAsJsonObject();                                        // 读取permitPrint值                    permitPrint = config.has("permitLogPrint") ? config.get("permitLogPrint").getAsBoolean() : false;                                        // 从配置中读取数据库配置，如果不存在则使用默认值                    JsonObject dbConfig = config.getAsJsonObject("database");                    if (dbConfig != null) {                        dbUrl = dbConfig.has("url") ? dbConfig.get("url").getAsString() : dbUrl;                        dbUser = dbConfig.has("username") ? dbConfig.get("username").getAsString() : dbUser;                        dbPassword = dbConfig.has("password") ? dbConfig.get("password").getAsString() : dbPassword;                        if (permitPrint) logger.log(Level.INFO, "数据库配置加载成功");                    } else {                        if (permitPrint) logger.log(Level.INFO, "配置文件中未找到数据库配置，使用默认配置");                    }                }            }        } catch (IOException e) {            if (permitPrint) logger.log(Level.SEVERE, "读取数据库配置文件时出错，使用默认配置", e);        } catch (JsonSyntaxException e) {            if (permitPrint) logger.log(Level.SEVERE, "解析数据库配置文件时出错，使用默认配置", e);        } catch (Exception e) {            if (permitPrint) logger.log(Level.SEVERE, "加载数据库配置时发生未知错误，使用默认配置", e);        } finally {            DB_URL = dbUrl;            DB_USER = dbUser;            DB_PASSWORD = dbPassword;            PERMIT_PRINT = permitPrint;        }    }    /**     * 构造函数     *      * @param sessionId 会话ID     */    public DatabaseManager(String sessionId) {        this.tableName = "session_" + sessionId.replace("-", "");        initializeDatabase();    }    /**     * 初始化数据库连接和会话表     */    private void initializeDatabase() {        String createTableSQL = "CREATE TABLE IF NOT EXISTS " + tableName + " (" +                "message_order INT NOT NULL PRIMARY KEY, " +                "role VARCHAR(20) NOT NULL, " +                "content TEXT NOT NULL, " +                "timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP" +                ")";                try (Connection conn = DriverManager.getConnection(DB_URL, DB_USER, DB_PASSWORD);             Statement stmt = conn.createStatement()) {            if (PERMIT_PRINT) logger.log(Level.INFO, "Attempting to create/access table: " + tableName);            boolean result = stmt.execute(createTableSQL);            if (PERMIT_PRINT) logger.log(Level.INFO, "Table creation result for " + tableName + ": " + result);        } catch (SQLException e) {            if (PERMIT_PRINT) logger.log(Level.SEVERE, "Failed to initialize database table: " + tableName, e);        }    }        /**     * 保存消息到数据库     *      * @param message 消息对象     * @param order 消息顺序     */    public void saveMessage(Message message, int order) {        String insertSQL = "INSERT INTO " + tableName + " (message_order, role, content) VALUES (?, ?, ?)";                try (Connection conn = DriverManager.getConnection(DB_URL, DB_USER, DB_PASSWORD);             PreparedStatement pstmt = conn.prepareStatement(insertSQL)) {            pstmt.setInt(1, order);            pstmt.setString(2, message.getRole());            pstmt.setString(3, message.getContent());            int rowsAffected = pstmt.executeUpdate();            if (PERMIT_PRINT) logger.log(Level.INFO, "Saved message to " + tableName + ", rows affected: " + rowsAffected +                      ", role: " + message.getRole() + ", content: " + message.getContent());        } catch (SQLException e) {            if (PERMIT_PRINT) logger.log(Level.SEVERE, "Failed to save message to database in table: " + tableName, e);        }    }        /**     * 从数据库加载对话历史     *      * @return 消息列表     */    public ArrayList<Message> loadHistory() {        ArrayList<Message> history = new ArrayList<>();        String selectSQL = "SELECT role, content FROM " + tableName + " ORDER BY message_order ASC";                if (PERMIT_PRINT) logger.log(Level.INFO, "Loading history from table: " + tableName);                try (Connection conn = DriverManager.getConnection(DB_URL, DB_USER, DB_PASSWORD);             PreparedStatement pstmt = conn.prepareStatement(selectSQL);             ResultSet rs = pstmt.executeQuery()) {                        int count = 0;            while (rs.next()) {                String role = rs.getString("role");                String content = rs.getString("content");                Message message = Message.builder()                        .role(role)                        .content(content)                        .build();                history.add(message);                count++;            }            if (PERMIT_PRINT) logger.log(Level.INFO, "Loaded " + count + " messages from table: " + tableName);        } catch (SQLException e) {            if (PERMIT_PRINT) logger.log(Level.SEVERE, "Failed to load message history from database table: " + tableName, e);        }                return history;    }}