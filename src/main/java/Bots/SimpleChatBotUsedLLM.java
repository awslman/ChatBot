package Bots;import java.util.HashMap;import java.util.Map;import java.util.Scanner;import java.util.concurrent.CompletableFuture;import java.util.concurrent.ExecutionException;import LLM.ModelHandler;import LLM.ResponseGenerator.GenericModelHandler;import io.reactivex.Flowable;import io.reactivex.disposables.Disposable;public class SimpleChatBotUsedLLM extends SimpleChatBot{    private String modelId;        // 模型处理器映射表    private final Map<String, ModelHandler> MODEL_HANDLERS = new HashMap<>();        // 模型名称映射表    private final Map<String, String> MODEL_NAMES = new HashMap<>();        public SimpleChatBotUsedLLM() {        super();        initializeModels();    }        private void initializeModels() {        // 初始化模型名称映射        MODEL_NAMES.put("1", "deepseek-r1-0528");        MODEL_NAMES.put("2", "deepseek-v3.1");        MODEL_NAMES.put("3", "Moonshot-Kimi-K2-Instruct");        MODEL_NAMES.put("4", "qwen3-max");        MODEL_NAMES.put("5", "qwen-plus");        // 添加新模型时只需在此处添加映射关系        // 不再预先初始化所有模型处理器，只在需要时创建    }    private ModelHandler getModelHandler(String modelId) {        // 检查是否已经有该模型的处理器        if (!MODEL_HANDLERS.containsKey(modelId)) {            // 如果没有，则创建并缓存            String modelName = MODEL_NAMES.get(modelId);            if (modelName != null) {                MODEL_HANDLERS.put(modelId, new GenericModelHandler(modelName));            }        }        return MODEL_HANDLERS.get(modelId);    }    @Override    public void processInput(String userInput) {        // 1. 首先尝试关键词匹配        String keywordResponse = keywordTrieTree.search(userInput);        if (keywordResponse != null) {            System.out.println("Bot: " + keywordResponse);        } else {            // 2.调用智能体应用api生成回复            try{                // 检查模型是否存在                    ModelHandler handler = getModelHandler(modelId);                    System.out.print("Bot: ");                    // 使用StringBuilder收集流式响应内容                    StringBuilder responseBuilder = new StringBuilder();                                        // 使用CompletableFuture处理流式响应                    CompletableFuture<Void> future = new CompletableFuture<>();                                        try {                        Flowable<String> stream = handler.generateResponseStream(userInput);                        Disposable disposable = stream.doOnError(future::completeExceptionally)                                .doOnComplete(() -> {                                    future.complete(null);                                    System.out.println(); // 换行                                })                                .subscribe(chunk -> {                                    System.out.print(chunk);                                    responseBuilder.append(chunk);                                });                                                // 等待流完成                        future.get();                        // 释放资源                        disposable.dispose();                        String fullResponse = responseBuilder.toString();                        handler.addBotMessage(fullResponse);                    } catch (ExecutionException e) {                        throw e.getCause();                    }            } catch (Throwable e) {                if (e.getMessage() != null && e.getMessage().contains("Model not exist")) {                    System.err.println("Bot: 模型不存在，请检查模型名称是否正确或是否有权限访问该模型");                } else {                    System.err.println("Bot: 调用模型时发生错误: " + e.getMessage());                }            }        }    }    @Override    public void run() {        Scanner scanner = new Scanner(System.in);        String input;        do {            clearScreen();            System.out.println("=== 简易聊天机器人 ===");            System.out.println("支持的模型:");            MODEL_NAMES.forEach((id, name) -> System.out.println("  " + id + " - " + name));            System.out.println("'quit'/'q' - 退出");            System.out.println("==================================================================");            System.out.print("请选择模型(" + String.join("/", MODEL_NAMES.keySet()) + "/quit): ");            this.modelId = scanner.nextLine().trim();            if (!modelId.equals("quit")&&!modelId.equals("q")) {                if(MODEL_NAMES.containsKey(modelId)) {                    clearScreen();                    System.out.println("=== 简易聊天机器人 ===");                    System.out.println("正在使用模型: " + MODEL_NAMES.getOrDefault(modelId, modelId));                    do {                        System.out.print("You: ");                        input = scanner.nextLine().trim();                        String userInput = input.toLowerCase();                        if (userInput.equals("q") || userInput.equals("quit")) {                            break;                        } else {                            processInput(userInput);                        }                    } while (!input.equalsIgnoreCase("quit") && !input.equalsIgnoreCase("q"));                }else {                    System.out.println("未知输入，请输入正确的模型编号");                }            }        } while (!modelId.equals("quit")&&!modelId.equals("q"));    }}